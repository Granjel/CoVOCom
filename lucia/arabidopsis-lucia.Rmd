---
title: "Arabidopsis Rodrigo"
author: "Lucía Martín"
date: "2025-07-28"
output: html_document
---

```{r library, echo = FALSE}

#cargamos los paquetes

library(lmerTest)
library(lsmeans)
library(ggplot2)
library(tidyr)
library(tidyverse)
library(vegan)
library(ggpubr)
library(ggrepel)
library(stats)
library(rmarkdown)
library(reshape)
library(dplyr)
library(multcomp)
library(permute)
library(lattice)
library(car)
library(glmmTMB)
library(DHARMa)
library(multcompView)

```

#VOCs groups
```{r VOCs groups, echo = FALSE}

### cargamos los datos como table

data <- read.csv(file = "lucia/VOCdivision.csv", h = T, sep = ";", na.strings = "NA")
data

head(data)
attach(data)

data$Gen <- as.factor(data$Gen)
data$Treat <- as.factor(data$Treat)
data$ID = as.factor(data$ID)
data$population = as.factor(data$population)

n_table <- data %>%
  group_by(Treat, population) %>%
  summarise(N = n(), .groups = "drop")

```



```{r normalidad, echo=FALSE}
str(data) #Que tipo de datos tengo
summary(data)

hist(data$Aromatic.compounds)
hist(sqrt(data$Aromatic.compounds))
hist(log(data$Aromatic.compounds))

hist(data$Alcohols.and.esters)
hist(sqrt(data$Alcohols.and.esters))
hist(log(data$Alcohols.and.esters))

hist(data$GLVs)
hist(sqrt(data$GLVs))
hist(log(data$GLVs))

hist(data$Long.chain.alkanes)
hist(sqrt(data$Long.chain.alkanes))
hist(log(data$Long.chain.alkanes))

hist(data$Monoterpenes)
hist(sqrt(data$Monoterpenes))
hist(log(data$Monoterpenes))
```

```{r MODELOs VOCs grupos, echo=FALSE}

#efecto tratamientio

#Aromatic.compounds: Acetophenone
lme = lmer(
  sqrt(Aromatic.compounds) ~ Treat * population + (1 | population:Gen),
  data = data
)
anova(lme) #me quedo con este

summary(lme)
resid(lme)
shapiro.test(resid(lme))
hist(resid(lme))

modelo2 <- glmmTMB(
  Aromatic.compounds ~ Treat * population + (1 | population:Gen),
  data = data,
  family = ziGamma(link = "log"),
  ziformula = ~1
)

Anova(modelo2, type = "III")
summary(modelo2)

modelo2 <- glmmTMB(
  Aromatic.compounds ~ Treat * population + (1 | population:Gen),
  family = glmmTMB::tweedie(link = "log"),
  data = data
)

Anova(modelo2, type = "III")

sim_res <- simulateResiduals(fittedModel = modelo2)
plot(sim_res)
testResiduals(sim_res)
testDispersion(sim_res)
testZeroInflation(sim_res)

#GLVs
lme = lmer(
  sqrt(GLVs) ~ H_E + Treat * population + (1 | population:Gen),
  data = data
)
anova(lme)

summary(lme)
resid(lme)
shapiro.test(resid(lme))
hist(resid(lme))

modelo2 <- glmmTMB(
  GLVs ~ Treat * population + (1 | population:Gen),
  data = data,
  family = ziGamma(link = "log"),
  ziformula = ~1
) #me quedo con este

Anova(modelo2, type = "III")
summary(modelo2)


sim_res <- simulateResiduals(fittedModel = modelo2)
plot(sim_res)
testResiduals(sim_res)
testDispersion(sim_res)
testZeroInflation(sim_res)

#Monoterpenes
lme = lmer(
  Monoterpenes ~ H_E + Treat * population + (1 | population:Gen),
  data = data
)
anova(lme)

summary(lme)
resid(lme)
shapiro.test(resid(lme))
hist(resid(lme))

modelo2 <- glmmTMB(
  Monoterpenes ~ Treat * population + (1 | population:Gen),
  data = data,
  family = ziGamma(link = "log"),
  ziformula = ~1
) #me quedo con este

Anova(modelo2, type = "III")
summary(modelo2)


sim_res <- simulateResiduals(fittedModel = modelo2)
plot(sim_res)
testResiduals(sim_res)
testDispersion(sim_res)
testZeroInflation(sim_res)

# Long chain alkanes
lme = lmer(
  log(Long.chain.alkanes + 1) ~ H_E + Treat * population + (1 | population:Gen),
  data = data
)
anova(lme)

summary(lme)
resid(lme)
shapiro.test(resid(lme))
hist(resid(lme))

modelo3 <- glmmTMB(
  Long.chain.alkanes ~ Treat * population + (1 | population:Gen),
  data = data,
  family = ziGamma(link = "log"),
  ziformula = ~1
) #me quedo con este

Anova(modelo3, type = "III")
summary(modelo3)

sim_res <- simulateResiduals(fittedModel = modelo2)
plot(sim_res)
testResiduals(sim_res)
testDispersion(sim_res)
testZeroInflation(sim_res)

#Alcohols and esters
lme = lmer(
  sqrt(Alcohols.and.esters) ~ Treat * population + (1 | population:Gen),
  data = data
)
anova(lme) #me quedo con este

summary(lme)
resid(lme)
shapiro.test(resid(lme))
hist(resid(lme))

modelo2 <- glmmTMB(
  Alcohols.and.esters ~ H_E + Treat * population + (1 | population:Gen),
  data = data,
  family = ziGamma(link = "log"),
  ziformula = ~1
)

Anova(modelo2, type = "III")
summary(modelo2)

sim_res <- simulateResiduals(fittedModel = modelo2)
plot(sim_res)
testResiduals(sim_res)
testDispersion(sim_res)
testZeroInflation(sim_res)

```


```{r medias grupos, echo=FALSE}
lsmeansglv = as.data.frame(lsmeans(
  modelo2,
  pairwise ~ Treat,
  adjustSigma = TRUE,
  adjust = "tukey",
  type = "response"
))

lsmeanslongchain = as.data.frame(lsmeans(
  modelo3,
  pairwise ~ Treat | population,
  adjustSigma = TRUE,
  adjust = "tukey",
  type = "response"
))

lsmeansglvs = lsmeans(
  modelo2,
  pairwise ~ Treat | population,
  adjustSigma = TRUE,
  adjust = "tukey"
) # tukey test

lsmeansglongchain = lsmeans(
  modelo3,
  pairwise ~ Treat | population,
  adjustSigma = TRUE,
  adjust = "tukey"
) # tukey test

lsmeans_result.glvs <- lsmeans(
  modelo2,
  pairwise ~ Treat | population,
  adjustSigma = TRUE,
  adjust = "tukey",
  type = "response"
)

cld(lsmeans_result.glvs)

lsmeans_result.longchain <- lsmeans(
  modelo3,
  pairwise ~ Treat | population,
  adjustSigma = TRUE,
  adjust = "tukey",
  type = "response"
)

cld(lsmeans_result.longchain)


library(openxlsx) #guardamos en excel
write.xlsx(lsmeansglv, "lsmeansglv.xlsx")
write.xlsx(lsmeanslongchain, "lsmeanslongchain.xlsx")
```


```{r Long chain alkanes, echo=FALSE}
lsmeanse = as.data.frame(lsmeans(
  modelo2,
  pairwise ~ Treat | population,
  adjustSigma = TRUE,
  adjust = "tukey",
  type = "response"
))

lsmeans = lsmeans(
  modelo2,
  pairwise ~ Treat | population,
  adjustSigma = TRUE,
  adjust = "tukey"
) # tukey test

lsmeans_result <- lsmeans(
  modelo2,
  pairwise ~ Treat | population,
  adjustSigma = TRUE,
  adjust = "tukey",
  type = "response"
)

cld(lsmeans_result)

library(openxlsx) #guardamos en excel
write.xlsx(lsmeanse, "lsmeans fatty acids.xlsx")

```


```{r Plot Alkanes emittersxpopulation, echo=FALSE}

data1 <- read.csv(
  file = "lsmeanslongchain.csv",
  h = T,
  sep = ";",
  na.strings = "NA"
)

data1

data1$population <- factor(data1$population, levels = c("Bon", "Cai"))
data1$Treat <- factor(data1$Treat, levels = c("c", "h"))

plotE <- ggplot(data1, aes(x = population, y = lsmean, fill = Treat)) +
  geom_bar(
    stat = "identity",
    position = position_dodge(0.8), # Separa barras por tratamiento
    width = 0.7,
    color = "black",
    linewidth = 0.5
  ) +
  geom_errorbar(
    aes(ymin = lsmean - SE, ymax = lsmean + SE),
    width = 0.2,
    position = position_dodge(0.8) # Alinea con las barras
  ) +
  labs(
    x = "Population",
    y = "Long chain alkanes emission (ng/h)",
    fill = "Emitter treatment"
  ) +
  scale_fill_manual(
    values = c("c" = "mintcream", "h" = "mediumseagreen"),
    labels = c("c" = "Control", "h" = "Herbivore-induced")
  ) +
  theme_bw() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "black"),
    legend.position = "top"
  )

plotE

ggsave(
  plotE,
  file = 'FIGURE long chain alkanes.tiff',
  width = 150,
  height = 100,
  units = 'mm',
  dpi = 300
)

```
