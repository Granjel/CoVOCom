
---
title: "Arabidopsis"
author: "Lucía Martín"
date: "2024-01-26"
output:
  pdf_document: default
  html_document: default
---

```{r library, echo = FALSE}

 #EFFECTS OF HERBIVORY TREATMENT ON ARABIDOPSIS

#cargamos los paquetes
  
library(lmerTest) #paquete para hacer modelos mixtos
library(lsmeans) #paquetes para sacar las medias
library(ggplot2) #paquete para hacer gr?ficos chulos
library(tidyr) #paquete para ordenar datos
library(tidyverse) #paquete para ordenar datos
library(vegan) #paquete para permanovas (analisis multivariante)
library(ggpubr)#paquete para hacer gr?ficos chulos
library(ggrepel)#paquete para hacer gr?ficos chulos
library(stats)
library(rmarkdown)
library(reshape)
library(dplyr)
library(ggrepel)
library(multcomp)
library(permute)
library(lattice)
library(car)

```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:
#Total VOCs emmisions
```{r Herbivory, echo = FALSE}

R.version

### cargamos los datos como table

data<-read.csv(file="damage.csv", h=T, sep=";",na.strings="NA")

data<-read.csv(file="population.csv", h=T, sep=";",na.strings="NA")

data<-read.csv(file="damage.emitters.csv", h=T, sep=";",na.strings="NA")


data

head(data)
attach(data)

data$Gen<-as.factor(data$Gen)
data$Treat<-as.factor(data$Treat)
data$ID = as.factor(data$ID)
data$population = as.factor(data$population)
data$herbivory_receiver= as.numeric(data$herbivory_receiver)
data$size_receiver = as.numeric(data$size_receiver)
data$herbivory_emitter= as.numeric(data$herbivory_emitter)

```

## Including Plots


```{r normalidad, echo=FALSE}

str(data) #Que tipo de datos tengo

#emitters

hist(data$herbivory_emitter)
hist(sqrt(data$herbivory_emitter))
hist(log(data$herbivory_emitter+1))


#receivers

hist(data$herbivory_receiver)
hist(sqrt(data$herbivory_receiver))
hist(log(data$herbivory_receiver+1))


summary(data)
```


```{r MODELO herbivoría emisoras, echo=FALSE}

#comprobamos efecto población

lme= lmer(sqrt(herbivory_emitter)~ H_E + population + (1|Gen), data=data) #genotipo como factor aleatorio hay efecto de la población

anova(lme)

summary(lme)
resid(lme)
shapiro.test((resid(lme)))
hist(resid(lme))

lsmeanse= as.data.frame(lsmeans(lme, pairwise ~ population, adjustSigma = TRUE, adjust = "tukey", type="response"))

library(openxlsx) #guardamos en excel
write.xlsx(lsmeanse, "lsmeans population emitters efct.xlsx")


#vemos efecto del genotipo dentro de cada población

lme= lm(sqrt(herbivory_emitter)~ H_E + Gen, data=data)

anova(lme)

lsmeanse= as.data.frame(lsmeans(lme, pairwise ~ Gen, adjustSigma = TRUE, adjust = "tukey", type="response"))

lsmeans=lsmeans(lme, pairwise ~ Gen, adjustSigma = TRUE, adjust = "tukey")# tukey test

lsmeans_result <- lsmeans(lme, pairwise ~ Gen, adjustSigma = TRUE, adjust = "tukey", type="response")

cld(lsmeans_result)

#efecto tratamientio con población como factor aleatorio

lme= lmer(sqrt(herbivory_emitter)~ H_E + Gen + (1|population), data=data)
anova(lme)

summary(lme)
resid(lme)
shapiro.test((resid(lme)))
hist(resid(lme))

lsmeanse= as.data.frame(lsmeans(lme, pairwise ~ Gen, adjustSigma = TRUE, adjust = "tukey", type="response"))

lsmeans=lsmeans(lme, pairwise ~ Gen, adjustSigma = TRUE, adjust = "tukey")# tukey test

lsmeans_result <- lsmeans(lme, pairwise ~ Gen, adjustSigma = TRUE, adjust = "tukey", type="response")

cld(lsmeans_result)

library(openxlsx) #guardamos en excel
write.xlsx(lsmeansh, "lsmeans emitters.xlsx")


```




```{r Plot damage emittersxpopulation, echo=FALSE}

data1 <- read.csv(file = "lsmeans population emitters efct.csv", h=T, sep=";", na.strings="NA") 

data1

data1$population <- as.factor(data1$population)

plotD= ggplot(data1, aes(x = population, y = lsmean, fill = population)) +
  geom_bar(stat = "identity", color = "black", linewidth = 0.5, width = 0.5) +
geom_errorbar(aes(ymin = lsmean - SE, ymax = lsmean + SE), width = 0.2) +
  labs(title = "", x = "Emitter population", y = "Leaf damage on emitters (%)") +
 scale_x_discrete(labels = c("B", "C")) +
  scale_fill_manual(values = c("lightgoldenrodyellow", "lavender")) +
theme_bw()+ theme(axis.title.y = element_text(margin = margin(t = 1, r = 12, b = 1, l = 1)))+ theme(axis.title.x = element_text(margin = margin(t = 10, r = 16, b = 10, l = 10)))+
  theme(legend.position = "none")  # Remove legend

plotE= plotD + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"))
  
plotE

ggsave(plotE, file = 'FIGURE emitter population and damage.2.tiff', width=150, height=100, units='mm', dpi=300)



```


```{r MODELO herbivoría receptoras, echo=FALSE}

#population as fixed factor

lmh= lmer(sqrt(herbivory_receiver)~ size_receiver + Treat*population + (1|Gen) , data=data) #no hay efecto

anova(lmh)

summary(lmh)
resid(lmh)
shapiro.test((resid(lmh)))
hist(resid(lmh))


#efecto tratamiento con población como random

lmh= lmer(sqrt(herbivory_receiver)~ size_receiver + Treat*Gen + (1|population), data=data)

anova(lmh)

summary(lmh)
resid(lmh)
shapiro.test((resid(lmh)))
hist(resid(lmh))

lsmeansh= as.data.frame(lsmeans(lmh, pairwise ~ Treat, adjustSigma = TRUE, adjust = "tukey", type="response"))

library(openxlsx) #guardamos en excel
write.xlsx(lsmeansh, "lsmeans receptoras Treat.xlsx")


```


```{r Plot damage emitters, echo=FALSE}

data1<-read.csv(file="lsmeans emitters.csv", h=T, sep=";", na.strings="NA") 

data1

data1$Gen<-as.factor(data1$Gen)


plotD= ggplot(data1, aes(x = Gen, y = lsmean, fill = Gen)) +
  geom_bar(stat = "identity", color = "black", linewidth = 0.5, width = 0.5) +
geom_errorbar(aes(ymin = lsmean - SE, ymax = lsmean + SE), width = 0.2) +
  labs(title = "", x = "Receiver genotype", y = "Leaf damage on emitters (%)") +
 scale_x_discrete(labels = c("1", "3", "5","8", "13", "14", "15", "19","24","26","28","30","34","37","43","45","50","53","55","56","57","60","61","64")) +
  scale_fill_manual(values = c("#7FFFD4", "#FAEBD7", "#0000FF", "#A52A2A", "#DEB887", "#5F9EA0", "#7FFF00", "#D2691E", "#CD8C95", "#FFF8DC", "#00FFFF", "#CAFF70", "#556B2F", "#FF8C00", "#9932CC", "#8FBC8F", "#FFFF00", "#FF1493", "#00BFFF", "#CDB5CD", "#FFD700", "#C1CDCD", "#FFDAB9", "#CD5C5C")) +
theme_bw()+ theme(axis.title.y = element_text(margin = margin(t = 1, r = 12, b = 1, l = 1)))+ theme(axis.title.x = element_text(margin = margin(t = 10, r = 16, b = 10, l = 10)))+
  theme(legend.position = "none")  # Remove legend

plotE= plotD + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"))
  
plotE

ggsave(plotE, file='FIGURE emitters damage.tiff', width=150, height=100, units='mm', dpi=300)



```



```{r Plot Treat, echo=FALSE}

data1<-read.csv(file="lsmeans receptoras Treat.csv", h=T, sep=";", na.strings="NA") 

data1
data1$Treat<-as.factor(data1$Treat)
data1$Treat <- factor(data1$Treat, levels = c("Control", "Herbivore-induced"))

plotD= ggplot(data1, aes(x = Treat, y = lsmean, fill = Treat)) +
  geom_bar(stat = "identity", color = "black", linewidth = 0.5, width = 0.5) +
  geom_errorbar(aes(ymin = lsmean - SE, ymax = lsmean + SE), width = 0.2) +
  labs(title = "", x = "Emitter induction treatment", y = "Leaf damage on receivers (%)") +
  scale_x_discrete(labels = c("Control", "Herbivore-induced")) +
  scale_fill_manual(values = c("mintcream","mediumseagreen")) +
  theme_bw()+
  theme(axis.title.y = element_text(margin = margin(t = 1, r = 12, b = 1, l = 1)))+
theme(axis.title.x = element_text(margin = margin(t = 1, r = 12, b = 1, l = 1)))

plotE= plotD + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"))

plotE

ggsave(plotE, file='FIGURE herbivory receivers.tiff', width=150, height=100, units='mm', dpi=300)


```



Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
```{r Herbivory genotype, echo=FALSE}

### subset controles para ver diferencias entre genotipos
data<-read.csv(file="genC.csv", h=T, sep=";", na.strings="NA")

data$Gen<-as.factor(data$Gen)
data$Treat<-as.factor(data$Treat)
data$ID = as.factor(data$ID)
data$population = as.factor(data$population)
data$herbivory_receiver= as.numeric(data$herbivory_receiver)
data$size_receiver = as.numeric(data$size_receiver)

hist(data$herbivory_receiver)
hist(sqrt(data$herbivory_receiver))
hist(log(data$herbivory_receiver+1))


lmh= lmer(sqrt(herbivory_receiver)~ size_receiver + Gen + (1|population), data=data)

summary(lmh)


lsmeans= as.data.frame(lsmeans(lmh, pairwise ~ Gen, adjustSigma = TRUE, adjust = "tukey", type="response"))

lsmeans=lsmeans(lmh, pairwise ~ Gen, adjustSigma = TRUE, adjust = "tukey")# tukey test

lsmeans_result <- lsmeans(lmh, pairwise ~ Gen, adjustSigma = TRUE, adjust = "tukey", type="response")

cld(lsmeans_result)

write.xlsx(lsmeans, "lsmeans receptoras genC.xlsx")

### subset inducidas para ver diferencias entre genotipos
data<-read.csv(file="genH.csv", h=T, sep=";", na.strings="NA")

data$Gen<-as.factor(data$Gen)
data$Treat<-as.factor(data$Treat)
data$ID = as.factor(data$ID)
data$population = as.factor(data$population)
data$herbivory_receiver= as.numeric(data$herbivory_receiver)
data$size_receiver = as.numeric(data$size_receiver)

hist(data$herbivory_receiver)
hist(sqrt(data$herbivory_receiver))
hist(log(data$herbivory_receiver+1))


lmh= lmer(sqrt(herbivory_receiver)~ size_receiver + Gen + (1|population), data=data)

anova(lmh)


lsmeans= as.data.frame(lsmeans(lmh, pairwise ~ Gen, adjustSigma = TRUE, adjust = "tukey", type="response"))

lsmeans=lsmeans(lmh, pairwise ~ Gen, adjustSigma = TRUE, adjust = "tukey")# tukey test

lsmeans_result <- lsmeans(lmh, pairwise ~ Gen, adjustSigma = TRUE, adjust = "tukey", type="response")

cld(lsmeans_result)


write.xlsx(lsmeans, "lsmeans receptoras genH.xlsx")

```




```{r Plot Herbivory genotype C, echo=FALSE}

data1<-read.csv(file="lsmeans receptoras genC.csv", h=T, sep=";", na.strings="NA") # EL BUENO

data1

data1$Gen<-as.factor(data1$Gen)


plotD= ggplot(data1, aes(x = Gen, y = lsmean, fill = Gen)) +
  geom_bar(stat = "identity", color = "black", linewidth = 0.5, width = 0.5) +
geom_errorbar(aes(ymin = lsmean - SE, ymax = lsmean + SE), width = 0.2) +
  labs(title = "", x = "Receiver genotype", y = "Leaf damage on receivers (%)") +
 scale_x_discrete(labels = c("1", "3", "5","8", "13", "14", "15", "19","24","26","28","30","34","37","43","45","50","53","55","56","57","60","61","64")) +
  scale_fill_manual(values = c("#7FFFD4", "#FAEBD7", "#0000FF", "#A52A2A", "#DEB887", "#5F9EA0", "#7FFF00", "#D2691E", "#CD8C95", "#FFF8DC", "#00FFFF", "#CAFF70", "#556B2F", "#FF8C00", "#9932CC", "#8FBC8F", "#FFFF00", "#FF1493", "#00BFFF", "#CDB5CD", "#FFD700", "#C1CDCD", "#FFDAB9", "#CD5C5C")) +
theme_bw()+ theme(axis.title.y = element_text(margin = margin(t = 1, r = 12, b = 1, l = 1)))+ theme(axis.title.x = element_text(margin = margin(t = 1, r = 12, b = 1, l = 1))) 

plotE= plotD + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"))
  
plotE

ggsave(plotE, file='FIGURE genC receivers.tiff', width=150, height=100, units='mm', dpi=300)


```


```{r Plot Herbivory genotype Induced, echo=FALSE}

data<-read.csv(file="lsmeans receptoras genH.csv", h=T, sep=";", na.strings="NA")

data
data$Gen<-as.factor(data$Gen)


plotD= ggplot(data, aes(x = Gen, y = lsmean, fill = Gen)) +
  geom_bar(stat = "identity", color = "black", linewidth = 0.5, width = 0.5) +
geom_errorbar(aes(ymin = lsmean - SE, ymax = lsmean + SE), width = 0.2) +
  labs(title = "", x = "Receiver genotype", y = "Leaf damage on receivers (%)") +
 scale_x_discrete(labels = c("1", "3", "5","8", "13", "14", "15", "19","24","26","28","30","34","37","43","45","50","53","55","56","57","60","61","64")) +
  scale_fill_manual(values = c("#7FFFD4", "#FAEBD7", "#0000FF", "#A52A2A", "#DEB887", "#5F9EA0", "#7FFF00", "#D2691E", "#CD8C95", "#FFF8DC", "#00FFFF", "#CAFF70", "#556B2F", "#FF8C00", "#9932CC", "#8FBC8F", "#FFFF00", "#FF1493", "#00BFFF", "#CDB5CD", "#FFD700", "#C1CDCD", "#FFDAB9", "#CD5C5C")) +
theme_bw()+ theme(axis.title.y = element_text(margin = margin(t = 1, r = 12, b = 1, l = 1)))+ theme(axis.title.x = element_text(margin = margin(t = 1, r = 12, b = 1, l = 1))) 

plotE= plotD + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"))
  
plotE

ggsave(plotE, file='FIGURE genH receivers.tiff', width=150, height=100, units='mm', dpi=300)


```




```{r VOCs, echo = FALSE}

### cargamos los datos como table

data<-read.csv(file="VOCs.csv", h=T, sep=";",na.strings="NA")
data

head(data)
attach(data)

data$Gen<-as.factor(data$Gen)
data$Treat<-as.factor(data$Treat)
data$ID = as.factor(data$ID)
data$population = as.factor(data$population)
data$Sum= as.numeric(data$Sum)
data$H_E= as.numeric(data$H_E)


```

## Including Plots


```{r Normalidad, echo=FALSE}
str(data) #Que tipo de datos tengo

hist(data$Sum)
hist(sqrt(data$Sum))
hist(log(data$Sum+1))

summary(data)
```


```{r MODELO Treatment herbivoría, echo=FALSE}

#efecto tratamiento; population as fixed factor

lm= lmer(sqrt(Sum)~ H_E + Treat*population + (1|G), data=data) #no hay efecto

anova(lm)

#efecto tratamiento; population as random factor

lm= lmer(sqrt(Sum)~ H_E + Treat*Gen + (1|population) , data=data)

anova(lm)


#diferencias

lsmeans= as.data.frame(lsmeans(lm, pairwise ~ Treat*Gen, adjustSigma = TRUE, adjust = "tukey", type="response"))

lsmeans= as.data.frame(lsmeans(lm, pairwise ~ Treat, adjustSigma = TRUE, adjust = "tukey", type="response"))

library(openxlsx) #guardamos en excel
write.xlsx(lsmeans, "lsmeans treat VOCs ng.sqrt.hr.xlsx")



```

```{r Plot Total VOCs emissions Treat, echo=FALSE}
data1<-read.csv(file="lsmeans TXG VOCs ng.sqrt.hr.csv", h=T, sep=";", na.strings="NA") 

data1
data1$Treat<-as.factor(data1$Treat)
data1$Gen<-as.factor(data1$Gen)



plotD = ggplot(data1, aes(x = Gen, y = lsmean, fill = Treat)) + 
  geom_bar(stat = "identity", color = "black", linewidth = 0.3, width = 0.5, position = position_dodge()) + # función "position = position_dodge" separa las barras de cada nivel de Treat para cada nivel de X en lugar de apilarlas, y "linewidth" controla el grosor de los márgenes en negrita
  geom_errorbar(aes(ymin = lsmean - SE, ymax = lsmean + SE),linewidth = 0.3, width = 0.2, position = position_dodge(width = 0.5)) +
  labs(title = "", x = "Genotype", y = "Total VOCs emission (ng/h)") +
  scale_x_discrete(labels = c("1", "3", "5","8", "13", "14", "15", "19","24","26","28","30","34","37","43","45","50","53","55","56","57","60","61","64")) +
  scale_fill_manual(values = c("mintcream","mediumseagreen"), labels = c("Control", "Herbivory")) + 
  theme_bw()+
 theme(axis.title.y = element_text(margin = margin(t = 1, r = 12, b = 1, l = 1)),
        axis.title.x = element_text(margin = margin(t = 12, r = 12, b = 12, l = 12)), # Separar el título del eje X del eje
        legend.position = c(.95, .95),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6),
        legend.title = element_blank(),
       axis.line = element_line(linewidth = 0.2)) # Reducir el grosor de los ejes

plotE= plotD + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"))


plotE



ggsave(plotE, file='Total VOCs emission.tiff', width=150, height=100, units='mm', dpi=300)


```

```{r PERMANOVA composition general, echo = FALSE}

#factors
factors = data[,c(1:8)] #factors
str(factors) #deben estar como factores

#variables
VOCS =data[,c(9:25)]
VOCS[is.na(VOCS)] = 0 #Use zeros
str(VOCS)#Deben estar como numericos

#step1:create a distance matrix from the variable dataframe

VOCS.dist = vegdist(VOCS, method='bray')

#step2: compute permanova. VEMOS EFECTO DE LA POBLACIÓN COMO FACTOR FIJO

perP = adonis2(VOCS.dist ~ H_E + Treat*population + strata(Gen), data=factors,  permutations=10000) #no hay efecto de la población

perP

#step2: compute permanova. VEMOS EFECTO DE LA POBLACIÓN COMO FACTOR ALEATORIO

per1 = adonis2(VOCS.dist ~ H_E + Treat*Gen + strata(population), data=factors,  permutations=10000)

per1



```



```{r anova vocS individuales, echo = FALSE}
volatiles = names(data) [c(9:25)] #variables to run the model over (volatiles, totals)

######Model volatiles ##### for log transformed add (i+1)
volatiles.lm = lapply(setNames(volatiles, volatiles), function(x) {
  lm(substitute(sqrt(i) ~ Treat*Gen, list(i = as.name(x))), data = data)
})

###anova sin correcciones de los datos de "volatiles.lm"
anova.volatiles<-lapply(volatiles.lm, anova) #anova
anova.volatiles #vemos el anova


library(openxlsx) #guardamos el anova en excel, nos sale un volátil por hoja de excel, cómo hacer un dataframe?
write.xlsx(anova.volatiles, "Anova VOCs individuales.xlsx")

######Apliclar a la p corrección "BH", alias "fdr":ya que tengo muchos compuestos, la corrección de Bonferroni es más restrictiva 


### A) metemos a mano los datos creando nuestra base de datos como p_values

#install.packages("dplyr")
#install.packages("knitr")
library(dplyr)
library(knitr)

p_values <- c (0.517510378,
0.533335176,
0.769879654,
0.560908581,
0.453713816,
0.328175949,
0.622100281,
0.436750367,
0.422024704,
0.579685872,
0.146238308,
0.466030192,
0.076672774,
0.033817716,
0.439457123,
0.488086345,
0.33974397)



## para BH
p_values_BH <- p.adjust(p = p_values, method = "BH")
names(p_values_BH) <- p_values_BH <= 0.05
p_values_BH

## para BONFERRONI

p_values_Bonferroni <- p.adjust(p = p_values, method = "bonferroni")
names(p_values_Bonferroni) <- p_values_Bonferroni <= 0.05
p_values_Bonferroni


##### con la función KABLE nos dice cuantos valores significativos hay según la correción BH (o fdr) y por Bonferroni
#puedo ver significancia por BH
#puedo ver significancia por Bonferroni: dividimos p de 0.05 entre mi num de muestras --> valores serán significativos por debajo de 0.05/n= X

n_1 <- length(p_values)
sin_correccion_1 <- sum(p_values <= 0.05)
bonferroni_1 <- sum(p.adjust(p =p_values, method="bonferroni") <= 0.05)
BH_1 <- sum(p.adjust(p = p_values, method = "BH") <= 0.05)

kable(data.frame(Numero_de_p.values = n_1, Sin_corrección = sin_correccion_1,
                 Bonferroni = bonferroni_1, Benjamini_Hochberg = BH_1 ), align="c")


```


```


```{r PcoA Treat composition, echo = FALSE}

#Unconstrained analysis

d.partial.pco.VOCS<-capscale(VOCS.dist ~ 1 + Condition(factors$Gen), data=factors, comm = VOCS) #Conditioning on Genotype (So ordination is performed after the Genotype effect is accounted for/removed)

head(summary(d.partial.pco.VOCS))

d.eig.VOCS<-eigenvals(d.partial.pco.VOCS)##extract eignevalues
d.eig.VOCS[1:3] / sum(d.eig.VOCS) #proportion of variance explained by each axis
cumsum(d.eig.VOCS[1:3] / sum(d.eig.VOCS)) #Same but cummulative

#Building the plot centroids for each treatment, unconstrained ordination
factors$ID = as.factor(factors$ID)

##Site ordination scores for MDS1 and MDS2 (for individuals/observations)
div.ind.VOCS<-data.frame(ID = rownames(d.partial.pco.VOCS$CA$u), treatment= factors$Treat, Plant=factors$ID,
                         MDS1 = scores(d.partial.pco.VOCS, scaling=3, correlation=TRUE)$sites[,1], 
                         MDS2 = scores(d.partial.pco.VOCS, scaling=3, correlation=TRUE)$sites[,2])


##use envfit for fitted order arrows
#inertia is variance in species (volatiles) abundance/composition
bt.VOCS.div<-cbind(factors%>%dplyr::select(ID, Treat), VOCS)
env.VOCS.div<-envfit(d.partial.pco.VOCS, bt.VOCS.div)
env.VOCS.div #Pay attention here. 
#VECTORS are the arrows 
#FACTORS are the centroids
#rsq T is 0 because we removed it from the model in the PcoA 
#We see the direction of the vector, the rsq and the p-value of each species (volatile)

div.cen.VOCS<-data.frame(T = rownames(env.VOCS.div$factors$centroids), MDS1 = env.VOCS.div$factors$centroids[,1], MDS2 = env.VOCS.div$factors$centroids[,2])%>%filter(T== 'Treatc' | T =='Treath') #Select centroids for herbivory

div.arrow.VOCS<-data.frame(order= rownames(env.VOCS.div$vectors$arrows), MDS1 = env.VOCS.div$vectors$arrows[,1], MDS2 = env.VOCS.div$vectors$arrows[,2], pval = env.VOCS.div$vectors$pvals, rsq = env.VOCS.div$vectors$r)%>%
  subset(pval <= 0.05 & rsq > 0.4) #Select arrows above ce

div.arrow.VOCS

##axis labels with var explained
xlabel<-paste0('MDS1 (', round(100*cumsum(d.eig.VOCS / sum(d.eig.VOCS))[[1]],2), '% of total variation)')
ylabel<-paste0('MDS2 (', round(100*(d.eig.VOCS[[2]] / sum(d.eig.VOCS)),2), '% of total variation)')


###Here we put everything we computed together and build the plot.

#first step: Plot the observations (sites) scores

#div.ind.VOCS$T <- factor(div.ind.VOCS$T, c("Q", "Q+B", "Q+P", "Q+B+P"))


###site.Plot.div.VOCS

site.Plot.div.VOCS<-ggplot(div.ind.VOCS, aes(x=MDS1, y=MDS2))+
  geom_jitter(aes(fill=treatment), shape=21,size=3, stroke= 0.8)+
  theme_classic()+
  scale_fill_manual(name = "",values=c("mintcream","mediumseagreen"), labels = c("Control", "Herbivory"))+
  theme(axis.line=element_blank())+
  geom_hline(aes(yintercept=0), lty='dashed', size=0.7)+
  geom_vline(aes(xintercept=0), lty='dashed', size=0.7)+
  labs(x=xlabel, y=ylabel)

site.Plot.div.VOCS

```





```{r Secondplot, echo = FALSE}

#con este código veo que VOCs son los que definen la variación

arrow.Plot.div.VOCS <-site.Plot.div.VOCS+
  geom_segment(data = div.arrow.VOCS, aes(x = 0, xend = MDS1*as.numeric(rsq), y = 0, yend = MDS2*as.numeric(rsq)),
               arrow = arrow(length = unit(0.2, "cm")), colour = "black", size=1)+
  geom_text_repel(data=div.arrow.VOCS, aes(x=MDS1*as.numeric(rsq), y=MDS2*as.numeric(rsq), label=order,min.segment.length = unit(5, 'lines'))) +
  # annotate("text", x=-0.2, y=0.40, label= "(Z)-??-farnesene")+
  # COMO HAYO x e y para ubicar el nombre del compuestoy quito la "X" en el nombre????
  theme(axis.line=element_blank(), axis.text=element_blank(), axis.ticks=element_blank(), axis.title=element_text(size=10))

arrow.Plot.div.VOCS

#Second step. Plot the arrows

arrow.Plot.div.VOCS <-site.Plot.div.VOCS+
  geom_segment(data = div.arrow.VOCS, aes(x = 0, xend = MDS1*as.numeric(rsq), y = 0, yend = MDS2*as.numeric(rsq)),
arrow = arrow(length = unit(0.30, "cm")), colour = "black",size=0.9)+
  geom_text_repel(data=div.arrow.VOCS, aes(x=MDS1*as.numeric(rsq),y=MDS2*as.numeric(rsq),
  label=(" "), min.segment.length = unit(5, 'lines'))) +
  annotate("text", x=-0.80, y=0.20, label= "Tridecane", size=4, fontface= "bold")+
  annotate("text", x=-1.1, y=0.10, label= "(E)-2-Methyl-2-butenal", size=4, fontface = "bold")+
 theme(axis.line=element_blank(), axis.text=element_blank(), axis.ticks=element_blank(), axis.title=element_text(size=14))

arrow.Plot.div.VOCS

```




```{r finalPLOT, echo = FALSE}
##Third step. add centroids for each irrigation treatment and 95% CI

Plot.div.VOCS<-arrow.Plot.div.VOCS+
  #This are centroids for ach treatment. 
  geom_point(data=subset(div.cen.VOCS, T == "Treatc"), aes(x=MDS1, y=MDS2), size= 3, pch = 23, lwd = 3, cex= 3, colour = "black", fill = "mintcream", stroke=0.8)+ #Control
  geom_point(data=subset(div.cen.VOCS, T == "Treath"), aes(x=MDS1, y=MDS2), size=3, pch = 23, lwd = 3, cex= 3, colour = "black", fill = "mediumseagreen", stroke=0.8)+ #herbivory
  stat_ellipse(aes(group=treatment, lty=treatment),type='norm', level=.95, col = "black", size = 0.7)+
  scale_linetype_manual(name = "", values = c(1,2), labels = c("Control", "Herbivory"))+
  theme(legend.position='right')+
  xlim(c(-1.6,1.6))+
  ylim(c(-1.6,1.6))+
  theme(axis.line=element_blank(), axis.text=element_blank(), axis.ticks=element_blank(), axis.title=element_text(size=14))
  #ggtitle("(a)")

Plot.div.VOCS

#save the pic
ggsave(Plot.div.VOCS, file='Figure VOCs PCoA Treat.tiff', width=150, height=100, units='mm', dpi=300)

```


```{r ANOVA Gen (control), echo = False }

data<-read.csv(file="VOCs.o.csv", h=T, sep=";",na.strings="NA")
data

head(data)
attach(data)

data$Gen<-as.factor(data$Gen)
data$Treat<-as.factor(data$Treat)
data$ID = as.factor(data$ID)
data$population = as.factor(data$population)
data$Sum= as.numeric(data$Sum)
data$H_E= as.numeric(data$H_E)

lm= lmer(Sum~ H_E + Gen + (1|population) , data=data)

lm= lmer(sqrt(Sum)~ H_E + Gen + (1|population) , data=data)

lm= lmer(log(Sum+1)~ H_E + Gen + (1|population) , data=data)

anova(lm)


lsmeans= as.data.frame(lsmeans(lm, pairwise ~ Gen, adjustSigma = TRUE, adjust = "tukey", type="response"))

library(openxlsx) #guardamos en excel
write.xlsx(lsmeans, "lsmeans GControl sqrt VOCs ng.sqrt.hr.xlsx")

```



```{r PERMANOVA Gen (control), echo = False }

#factors
factors = data[,c(1:8)] #factors
str(factors) #deben estar como factores

#variables
VOCS =data[,c(9:25)]
VOCS[is.na(VOCS)] = 0 #Use zeros
str(VOCS)#Deben estar como numericos

#step1:create a distance matrix from the variable dataframe

VOCS.dist = vegdist(VOCS, method='bray')

#step2: compute permanova

per2 = adonis2(VOCS.dist ~ H_E + Gen + strata(population), data=factors,  permutations=10000)

per2
```



```{r PcoA Gen Control, echo = FALSE}


#Unconstrained analysis

d.partial.pco.VOCS<-capscale(VOCS.dist ~ 1 + Condition(factors$population), data=factors, comm = VOCS) #Conditioning on Genotype (So ordination is performed after the Genotype effect is accounted for/removed)

head(summary(d.partial.pco.VOCS))

d.eig.VOCS<-eigenvals(d.partial.pco.VOCS)##extract eignevalues
d.eig.VOCS[1:3] / sum(d.eig.VOCS) #proportion of variance explained by each axis
cumsum(d.eig.VOCS[1:3] / sum(d.eig.VOCS)) #Same but cummulative

#Building the plot centroids for each treatment, unconstrained ordination
factors$ID = as.factor(factors$ID)

##Site ordination scores for MDS1 and MDS2 (for individuals/observations)
div.ind.VOCS<-data.frame(ID = rownames(d.partial.pco.VOCS$CA$u), treatment= factors$Gen, Plant=factors$ID,
                         MDS1 = scores(d.partial.pco.VOCS, scaling=3, correlation=TRUE)$sites[,1], 
                         MDS2 = scores(d.partial.pco.VOCS, scaling=3, correlation=TRUE)$sites[,2])


##use envfit for fitted order arrows
#inertia is variance in species (volatiles) abundance/composition
bt.VOCS.div<-cbind(factors%>%dplyr::select(ID, Gen), VOCS)
env.VOCS.div<-envfit(d.partial.pco.VOCS, bt.VOCS.div)
env.VOCS.div #Pay attention here. 
#VECTORS are the arrows 
#FACTORS are the centroids
#rsq T is 0 because we removed it from the model in the PcoA 
#We see the direction of the vector, the rsq and the p-value of each species (volatile)

div.cen.VOCS<-data.frame(T = rownames(env.VOCS.div$factors$centroids), MDS1 = env.VOCS.div$factors$centroids[,1], MDS2 = env.VOCS.div$factors$centroids[,2])%>%filter(T== "Gen1"| T== "Gen3"| T== "Gen5"|T== "Gen8"| T== "Gen13"| T== "Gen14"| T== "Gen15"| T== "Gen19"|T== "Gen24"|T== "Gen26"|T== "Gen28"|T== "Gen30"|T== "Gen34"|T== "Gen37"|T== "Gen43"|T== "Gen45"|T== "Gen50"|T== "Gen53"|T== "Gen55"|T== "Gen56"|T== "Gen57"|T== "Gen60"|T== "Gen61"|T== "Gen64") #Select centroids for herbivory

div.arrow.VOCS<-data.frame(order= rownames(env.VOCS.div$vectors$arrows), MDS1 = env.VOCS.div$vectors$arrows[,1], MDS2 = env.VOCS.div$vectors$arrows[,2], pval = env.VOCS.div$vectors$pvals, rsq = env.VOCS.div$vectors$r)%>%
  subset(pval <= 0.05 & rsq > 0.7) #Select arrows above ce

div.arrow.VOCS

##axis labels with var explained
xlabel<-paste0('MDS1 (', round(100*cumsum(d.eig.VOCS / sum(d.eig.VOCS))[[1]],2), '% of total variation)')
ylabel<-paste0('MDS2 (', round(100*(d.eig.VOCS[[2]] / sum(d.eig.VOCS)),2), '% of total variation)')


###Here we put everything we computed together and build the plot.

#first step: Plot the observations (sites) scores

#div.ind.VOCS$T <- factor(div.ind.VOCS$T, c("Q", "Q+B", "Q+P", "Q+B+P"))


###site.Plot.div.VOCS

site.Plot.div.VOCS<-ggplot(div.ind.VOCS, aes(x=MDS1, y=MDS2))+
  geom_jitter(aes(fill=treatment), shape=21,size=3, stroke= 0.8)+
  theme_classic()+
  scale_fill_manual(name = "",values=c("#7FFFD4", "#FAEBD7", "#0000FF", "#A52A2A", "#DEB887", "#5F9EA0", "#7FFF00", "#D2691E", "#CD8C95", "#FFF8DC", "#00FFFF", "#CAFF70", "#556B2F", "#FF8C00", "#9932CC", "#8FBC8F", "#FFFF00", "#FF1493", "#00BFFF", "#CDB5CD", "#FFD700", "#C1CDCD", "#FFDAB9", "#CD5C5C"), labels = c("1", "3", "5","8", "13", "14", "15", "19","24","26","28","30","34","37","43","45","50","53","55","56","57","60","61","64"))+
  theme(axis.line=element_blank())+
  geom_hline(aes(yintercept=0), lty='dashed', size=0.7)+
  geom_vline(aes(xintercept=0), lty='dashed', size=0.7)+
  labs(x=xlabel, y=ylabel)

site.Plot.div.VOCS

```




```{r Secondplot, echo = FALSE}

#con este código veo que VOCs son los que definen la variación

arrow.Plot.div.VOCS <-site.Plot.div.VOCS+
  geom_segment(data = div.arrow.VOCS, aes(x = 0, xend = MDS1*as.numeric(rsq), y = 0, yend = MDS2*as.numeric(rsq)),
               arrow = arrow(length = unit(0.2, "cm")), colour = "black", size=1)+
  geom_text_repel(data=div.arrow.VOCS, aes(x=MDS1*as.numeric(rsq), y=MDS2*as.numeric(rsq), label=order,min.segment.length = unit(5, 'lines'))) +
  # annotate("text", x=-0.2, y=0.40, label= "(Z)-??-farnesene")+
  # COMO HAYO x e y para ubicar el nombre del compuestoy quito la "X" en el nombre????
  theme(axis.line=element_blank(), axis.text=element_blank(), axis.ticks=element_blank(), axis.title=element_text(size=10))

arrow.Plot.div.VOCS

#Second step. Plot the arrows

arrow.Plot.div.VOCS <-site.Plot.div.VOCS+
  geom_segment(data = div.arrow.VOCS, aes(x = 0, xend = MDS1*as.numeric(rsq), y = 0, yend = MDS2*as.numeric(rsq)),
arrow = arrow(length = unit(0.30, "cm")), colour = "black",size=0.9)+
  geom_text_repel(data=div.arrow.VOCS, aes(x=MDS1*as.numeric(rsq),y=MDS2*as.numeric(rsq),
  label=(" "), min.segment.length = unit(5, 'lines'))) +
  annotate("text", x=1.15, y=0.18, label= "Tridecane", size=4, fontface= "bold")+
   annotate("text", x=0.94, y=0.35, label= "Tetradecane", size=4, fontface= "bold")+
   annotate("text", x=1.10, y=0.27, label= "Dodecanal", size=4, fontface= "bold")+
  annotate("text", x=1.20, y=0.10, label= "(E)-2-Methyl-2-butenal", size=4, fontface = "bold")+
 theme(axis.line=element_blank(), axis.text=element_blank(), axis.ticks=element_blank(), axis.title=element_text(size=14))+ xlim(c(-1.8,1.8))+
  ylim(c(-1.0,1.0))
  

arrow.Plot.div.VOCS

ggsave(arrow.Plot.div.VOCS, file='Figure VOCs PCoA Control.tiff', width=150, height=100, units='mm', dpi=300)

```




```{r finalPLOT, echo = FALSE}
##Third step. add centroids for each irrigation treatment and 95% CI

Plot.div.VOCS<-arrow.Plot.div.VOCS+
  #This are centroids for ach treatment. 
  geom_point(data=subset(div.cen.VOCS, T == "Gen1"), aes(x=MDS1, y=MDS2), size= 3, pch = 23, lwd = 3, cex= 3, colour = "black", fill = "#7FFFD4", stroke=0.8)+ 
  geom_point(data=subset(div.cen.VOCS, T == "Gen3"), aes(x=MDS1, y=MDS2), size= 3, pch = 23, lwd = 3, cex= 3, colour = "black", fill = "#FAEBD7",  stroke=0.8)+
  geom_point(data=subset(div.cen.VOCS, T == "Gen5"), aes(x=MDS1, y=MDS2), size= 3, pch = 23, lwd = 3, cex= 3, colour = "black", fill = "#0000FF", stroke=0.8)+
  geom_point(data=subset(div.cen.VOCS, T == "Gen8"), aes(x=MDS1, y=MDS2), size= 3, pch = 23, lwd = 3, cex= 3, colour = "black", fill = "#A52A2A", stroke=0.8)+
  geom_point(data=subset(div.cen.VOCS, T == "Gen13"), aes(x=MDS1, y=MDS2), size= 3, pch = 23, lwd = 3, cex= 3, colour = "black", fill = "#DEB887", stroke=0.8)+
  geom_point(data=subset(div.cen.VOCS, T == "Gen14"), aes(x=MDS1, y=MDS2), size= 3, pch = 23, lwd = 3, cex= 3, colour = "black", fill = "#5F9EA0", stroke=0.8)+
  geom_point(data=subset(div.cen.VOCS, T == "Gen15"), aes(x=MDS1, y=MDS2), size= 3, pch = 23, lwd = 3, cex= 3, colour = "black", fill = "#7FFF00", stroke=0.8)+
  geom_point(data=subset(div.cen.VOCS, T == "Gen19"), aes(x=MDS1, y=MDS2), size= 3, pch = 23, lwd = 3, cex= 3, colour = "black", fill = "#D2691E", stroke=0.8)+
  geom_point(data=subset(div.cen.VOCS, T == "Gen24"), aes(x=MDS1, y=MDS2), size= 3, pch = 23, lwd = 3, cex= 3, colour = "black", fill = "#CD8C95", stroke=0.8)+
  geom_point(data=subset(div.cen.VOCS, T == "Gen26"), aes(x=MDS1, y=MDS2), size= 3, pch = 23, lwd = 3, cex= 3, colour = "black", fill = "#FFF8DC", stroke=0.8)+
  geom_point(data=subset(div.cen.VOCS, T == "Gen28"), aes(x=MDS1, y=MDS2), size= 3, pch = 23, lwd = 3, cex= 3, colour = "black", fill = "#00FFFF",  stroke=0.8)+
  geom_point(data=subset(div.cen.VOCS, T == "Gen30"), aes(x=MDS1, y=MDS2), size= 3, pch = 23, lwd = 3, cex= 3, colour = "black", fill = "#CAFF70", stroke=0.8)+
  geom_point(data=subset(div.cen.VOCS, T == "Gen34"), aes(x=MDS1, y=MDS2), size= 3, pch = 23, lwd = 3, cex= 3, colour = "black", fill = "#556B2F", stroke=0.8)+
  geom_point(data=subset(div.cen.VOCS, T == "Gen37"), aes(x=MDS1, y=MDS2), size= 3, pch = 23, lwd = 3, cex= 3, colour = "black", fill = "#FF8C00", stroke=0.8)+
  geom_point(data=subset(div.cen.VOCS, T == "Gen43"), aes(x=MDS1, y=MDS2), size= 3, pch = 23, lwd = 3, cex= 3, colour = "black", fill = "#9932CC", stroke=0.8)+
  geom_point(data=subset(div.cen.VOCS, T == "Gen45"), aes(x=MDS1, y=MDS2), size= 3, pch = 23, lwd = 3, cex= 3, colour = "black", fill = "#8FBC8F", stroke=0.8)+
  geom_point(data=subset(div.cen.VOCS, T == "Gen50"), aes(x=MDS1, y=MDS2), size= 3, pch = 23, lwd = 3, cex= 3, colour = "black", fill = "#FFFF00", stroke=0.8)+
  geom_point(data=subset(div.cen.VOCS, T == "Gen53"), aes(x=MDS1, y=MDS2), size= 3, pch = 23, lwd = 3, cex= 3, colour = "black", fill = "#FF1493", stroke=0.8)+
  geom_point(data=subset(div.cen.VOCS, T == "Gen55"), aes(x=MDS1, y=MDS2), size= 3, pch = 23, lwd = 3, cex= 3, colour = "black", fill = "#00BFFF", stroke=0.8)+
  geom_point(data=subset(div.cen.VOCS, T == "Gen56"), aes(x=MDS1, y=MDS2), size= 3, pch = 23, lwd = 3, cex= 3, colour = "black", fill = "#CDB5CD", stroke=0.8)+
  geom_point(data=subset(div.cen.VOCS, T == "Gen57"), aes(x=MDS1, y=MDS2), size= 3, pch = 23, lwd = 3, cex= 3, colour = "black", fill = "#FFD700", stroke=0.8)+
  geom_point(data=subset(div.cen.VOCS, T == "Gen60"), aes(x=MDS1, y=MDS2), size= 3, pch = 23, lwd = 3, cex= 3, colour = "black", fill = "#C1CDCD", stroke=0.8)+
  geom_point(data=subset(div.cen.VOCS, T == "Gen61"), aes(x=MDS1, y=MDS2), size= 3, pch = 23, lwd = 3, cex= 3, colour = "black", fill = "#FFDAB9", stroke=0.8)+
  geom_point(data=subset(div.cen.VOCS, T == "Gen64"), aes(x=MDS1, y=MDS2), size= 3, pch = 23, lwd = 3, cex= 3, colour = "black", fill = "#CD5C5C", stroke=0.8)+
  stat_ellipse(aes(group=treatment, lty=treatment),type='norm', level=.95, col = "black", size = 0.7)+
  scale_linetype_manual(name = "", values = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24), labels = c("1", "3", "5","8", "13", "14", "15", "19","24","26","28","30","34","37","43","45","50","53","55","56","57","60","61","64"))+
  theme(legend.position='right')+
  xlim(c(-1.6,1.6))+
  ylim(c(-1.6,1.6))+
  theme(axis.line=element_blank(), axis.text=element_blank(), axis.ticks=element_blank(), axis.title=element_text(size=14))
  #ggtitle("(a)")

Plot.div.VOCS

#save the pic
ggsave(Plot.div.VOCS, file='Figure VOCs PCoA Control.tiff', width=150, height=100, units='mm', dpi=300)

```



```{r ANOVA Gen (control), echo = False }

data<-read.csv(file="VOCs.h.csv", h=T, sep=";",na.strings="NA")
data

head(data)
attach(data)

data$Gen<-as.factor(data$Gen)
data$Treat<-as.factor(data$Treat)
data$ID = as.factor(data$ID)
data$population = as.factor(data$population)
data$Sum= as.numeric(data$Sum)
data$H_E= as.numeric(data$H_E)

lm= lmer(Sum~ H_E + Gen + (1|population) , data=data)

lm= lmer(sqrt(Sum)~ H_E + Gen + (1|population) , data=data)

lm= lmer(log(Sum+1)~ H_E + Gen + (1|population) , data=data)

anova(lm)

lsmeans= as.data.frame(lsmeans(lm, pairwise ~ Gen, adjustSigma = TRUE, adjust = "tukey", type="response"))

library(openxlsx) #guardamos en excel
write.xlsx(lsmeans, "lsmeans Ginduc log VOCs ng.sqrt.hr.xlsx")

```




```{r PERMANOVA Gen (Induced), echo = False }


#factors
factors = data[,c(1:8)] #factors
str(factors) #deben estar como factores

#variables
VOCS =data[,c(9:25)]
VOCS[is.na(VOCS)] = 0 #Use zeros
str(VOCS)#Deben estar como numericos

#step1:create a distance matrix from the variable dataframe

VOCS.dist = vegdist(VOCS, method='bray')

#step2: compute permanova

per3 = adonis2(VOCS.dist ~ H_E + Gen + strata(population), data=factors,  permutations=10000)

per3
```




```{r PcoA Gen Induced, echo = FALSE}


#Unconstrained analysis

d.partial.pco.VOCS<-capscale(VOCS.dist ~ 1 + Condition(factors$population), data=factors, comm = VOCS) #Conditioning on Genotype (So ordination is performed after the Genotype effect is accounted for/removed)

head(summary(d.partial.pco.VOCS))

d.eig.VOCS<-eigenvals(d.partial.pco.VOCS)##extract eignevalues
d.eig.VOCS[1:3] / sum(d.eig.VOCS) #proportion of variance explained by each axis
cumsum(d.eig.VOCS[1:3] / sum(d.eig.VOCS)) #Same but cummulative

#Building the plot centroids for each treatment, unconstrained ordination
factors$ID = as.factor(factors$ID)

##Site ordination scores for MDS1 and MDS2 (for individuals/observations)
div.ind.VOCS<-data.frame(ID = rownames(d.partial.pco.VOCS$CA$u), treatment= factors$Gen, Plant=factors$ID,
                         MDS1 = scores(d.partial.pco.VOCS, scaling=3, correlation=TRUE)$sites[,1], 
                         MDS2 = scores(d.partial.pco.VOCS, scaling=3, correlation=TRUE)$sites[,2])


##use envfit for fitted order arrows
#inertia is variance in species (volatiles) abundance/composition
bt.VOCS.div<-cbind(factors%>%dplyr::select(ID, Gen), VOCS)
env.VOCS.div<-envfit(d.partial.pco.VOCS, bt.VOCS.div)
env.VOCS.div #Pay attention here. 
#VECTORS are the arrows 
#FACTORS are the centroids
#rsq T is 0 because we removed it from the model in the PcoA 
#We see the direction of the vector, the rsq and the p-value of each species (volatile)

div.cen.VOCS<-data.frame(T = rownames(env.VOCS.div$factors$centroids), MDS1 = env.VOCS.div$factors$centroids[,1], MDS2 = env.VOCS.div$factors$centroids[,2])%>%filter(T== "Gen1"| T== "Gen3"| T== "Gen5"|T== "Gen8"| T== "Gen13"| T== "Gen14"| T== "Gen15"| T== "Gen19"|T== "Gen24"|T== "Gen26"|T== "Gen28"|T== "Gen30"|T== "Gen34"|T== "Gen37"|T== "Gen43"|T== "Gen45"|T== "Gen50"|T== "Gen53"|T== "Gen55"|T== "Gen56"|T== "Gen57"|T== "Gen60"|T== "Gen61"|T== "Gen64") #Select centroids for herbivory

div.arrow.VOCS<-data.frame(order= rownames(env.VOCS.div$vectors$arrows), MDS1 = env.VOCS.div$vectors$arrows[,1], MDS2 = env.VOCS.div$vectors$arrows[,2], pval = env.VOCS.div$vectors$pvals, rsq = env.VOCS.div$vectors$r)%>%
  subset(pval <= 0.05 & rsq > 0.7) #Select arrows above ce

div.arrow.VOCS

##axis labels with var explained
xlabel<-paste0('MDS1 (', round(100*cumsum(d.eig.VOCS / sum(d.eig.VOCS))[[1]],2), '% of total variation)')
ylabel<-paste0('MDS2 (', round(100*(d.eig.VOCS[[2]] / sum(d.eig.VOCS)),2), '% of total variation)')


###Here we put everything we computed together and build the plot.

#first step: Plot the observations (sites) scores

#div.ind.VOCS$T <- factor(div.ind.VOCS$T, c("Q", "Q+B", "Q+P", "Q+B+P"))


###site.Plot.div.VOCS

site.Plot.div.VOCS<-ggplot(div.ind.VOCS, aes(x=MDS1, y=MDS2))+
  geom_jitter(aes(fill=treatment), shape=21,size=3, stroke= 0.8)+
  theme_classic()+
  scale_fill_manual(name = "",values=c("#7FFFD4", "#FAEBD7", "#0000FF", "#A52A2A", "#DEB887", "#5F9EA0", "#7FFF00", "#D2691E", "#CD8C95", "#FFF8DC", "#00FFFF", "#CAFF70", "#556B2F", "#FF8C00", "#9932CC", "#8FBC8F", "#FFFF00", "#FF1493", "#00BFFF", "#CDB5CD", "#FFD700", "#C1CDCD", "#FFDAB9", "#CD5C5C"), labels = c("1", "3", "5","8", "13", "14", "15", "19","24","26","28","30","34","37","43","45","50","53","55","56","57","60","61","64"))+
  theme(axis.line=element_blank())+
  geom_hline(aes(yintercept=0), lty='dashed', size=0.7)+
  geom_vline(aes(xintercept=0), lty='dashed', size=0.7)+
  labs(x=xlabel, y=ylabel)

site.Plot.div.VOCS

```




```{r Secondplot, echo = FALSE}

#con este código veo que VOCs son los que definen la variación

arrow.Plot.div.VOCS <-site.Plot.div.VOCS+
  geom_segment(data = div.arrow.VOCS, aes(x = 0, xend = MDS1*as.numeric(rsq), y = 0, yend = MDS2*as.numeric(rsq)),
               arrow = arrow(length = unit(0.2, "cm")), colour = "black", size=1)+
  geom_text_repel(data=div.arrow.VOCS, aes(x=MDS1*as.numeric(rsq), y=MDS2*as.numeric(rsq), label=order,min.segment.length = unit(5, 'lines'))) +
  # annotate("text", x=-0.2, y=0.40, label= "(Z)-??-farnesene")+
  # COMO HAYO x e y para ubicar el nombre del compuestoy quito la "X" en el nombre????
  theme(axis.line=element_blank(), axis.text=element_blank(), axis.ticks=element_blank(), axis.title=element_text(size=10))

arrow.Plot.div.VOCS

#Second step. Plot the arrows

arrow.Plot.div.VOCS <-site.Plot.div.VOCS+
  geom_segment(data = div.arrow.VOCS, aes(x = 0, xend = MDS1*as.numeric(rsq), y = 0, yend = MDS2*as.numeric(rsq)),
arrow = arrow(length = unit(0.30, "cm")), colour = "black",size=0.9)+
  geom_text_repel(data=div.arrow.VOCS, aes(x=MDS1*as.numeric(rsq),y=MDS2*as.numeric(rsq),
  label=(" "), min.segment.length = unit(5, 'lines'))) +
  #annotate("text", x=1.15, y=0.18, label= "Tridecane", size=4, fontface= "bold")+
   #annotate("text", x=0.94, y=0.35, label= "Tetradecane", size=4, fontface= "bold")+
   #annotate("text", x=1.10, y=0.27, label= "Dodecanal", size=4, fontface= "bold")+
  annotate("text", x=1.04, y=0.22, label= "(E)-2-Methyl-2-butenal", size=4, fontface = "bold")+
 theme(axis.line=element_blank(), axis.text=element_blank(), axis.ticks=element_blank(), axis.title=element_text(size=14))+ xlim(c(-1.6,1.6))+
  ylim(c(-1.5,1.5))
  

arrow.Plot.div.VOCS

ggsave(arrow.Plot.div.VOCS, file='Figure VOCs PCoA induced.tiff', width=150, height=100, units='mm', dpi=300)

```